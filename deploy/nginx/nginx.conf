worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Define the upstream Django application server
    upstream backend {
        # 'web' is the service name from docker-compose.yml
        server web:8000;
    }

    server {
        listen 80;
        server_name localhost;
        charset utf-8;

        # Max upload size
        client_max_body_size 75M;

        # This single location block will proxy all requests to the Django backend.
        # This correctly handles /api/ingest/, /admin/, /metrics, and Django's static files.
        location / {
            proxy_pass http://backend;

            # Set headers to pass necessary information to the Django app
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Required for WebSocket support if you add it later
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}